---
layout: post
title: 翻译 - Yarn 一个新的 JavaScript包管理器
tags: translate yarn js
---

在 JavaScript 社区，工程师们分享成千上万个代码包，使得我们不用重复编写我们自己的基本组件，库，或者框架。每一个代码库又可能依赖于另外的几个代码库，这些依赖被包管理器所管理。最出名的 JavaScript 包管理器是 npm client， 它提供了连接进 npm 仓库(registry) 的方式，它拥有超过30万个包！ 还有超过 500 万工程师使用着每月下载量超过 50 亿的 npm client！

Facebook 曾很开心地用着 npm client 很多年，但是随着我们基础代码的扩大和工程师的加入成长，我们碰到了 *一致性(consistency)*，*安全性(security)*和*性能(performance)* 的问题。在每次出现问题之后我们都竭力尝试去解决，之后，我们开始构建一个新的解决方案去帮助我们更可靠地管理我们的依赖包。这个产品被称为 **Yarn** —— 一个快速的，可靠地，安全的 npm client 替代品。

我们很高兴地宣布这个 Exponent, Google, Tilde 的协作产品 —— Yarn 的开源。有了 Yarn，工程师仍然可以进入 npm 仓库(registry)，但是安装 *包(package)* 会更快，并且依赖管理在跨机器或者安全离线环境下也拥有一致性。Yarn 使得工程师们可以更快地，更有信心地使用别人的代码，这样他们就能关注于他们的工作 —— 创建一个新产品，创造一个新特性。

## JavaScript 包管理器在 Facebook 的进化

在包管理器出现之前，JavaScript 工程师们把几个数量很少的依赖，直接存在项目，或者放在 CDN 中是很常见的。第一个主流的 JavaScript 包管理器，npm, 在 Node.js 被发布(introduced) 很短时间之后就被做出来了，它也很快变成了世界上最受欢迎的包管理器之一。成千上万的新的开源项目被创建，工程师们也比原先分享了更多的代码。

我们 Facebook 中，像是 React 的很多项目都依赖 npm 的代码。然而随着我们的内部拓展，我们遇到了一些一致性的问题：在不同的用户和机器之间安装依赖的时候，它总是会花很多时间下载依赖，还有会自动从其他依赖中运行一些代码这样的安全问题。我们尝试去围绕着这几个问题做出解决方案，但是它们又会引发出新的问题。

## 尝试去拓展 npm 客户端

最初，跟着最佳实践，我们只是检查 package.json 并要求工程师们手动执行 `npm install`. 这些工作对工程师来说足够了，但是在我们的 CI 环境中就挂了。CI 环境因为安全性和可靠性的原因需要进沙盒并且断网。

我们实施的下一个方案是把 node_modules 里面的东西放到仓库里。当做的时候发现这些简单的操作其实非常困难。比如，为 babel 更新了一个小版本就产生了 80 万行的提交。这些提交很难去 land 并触发针对非法 uf8 字节序列的 lint 规则的，非法 utf8 字节序列就像是 windows 结束符，非压缩的 png 图片还有其他。。。合并这些改变到 node_modules 通常会使得几个工程师花费上一整天。我们的代码管理团队也指出我们检测 node_modules 文件夹必须得为数量巨大的元数据负责。React Native 的 package.json现在只是列了 68 个依赖，但是运行 npm install 之后，node_modules 文件夹中会包含 121,358 个文件。

我们做出的最后一个尝试是拓展 npm 客户端，使之适应我们 Facebook 的工程师们和需要安装的代码量。我们决定去压缩整个 node_modules 文件夹并把它上传到一个内部 CDN，这样我们的工程师和 CI 系统都能有着一致性下载并解压这些文件。这样使我们在代码管理中移除了成百上千个文件，但是这么做的话，我们的工程师联网不仅仅是去下载新代码，还要创建它。

我们也不得不围绕着我们曾用来锁定依赖版本号的 [shrinkwrap](https://docs.npmjs.com/cli/shrinkwrap) 特性搞事。Shrinkwrap 文件不会默认生成，并且如果工程师忘记的话，它也会在同步的时候丢失。所以我们就写了个工具去验证 shrinkwrap 文件是否匹配 node_modules 中的内容。这些文件是有着未排序的 key 的数量巨大的 JSON blobs。所以对他们的改变会产生大量的，难以检查的提交。为了减轻这种(痛苦)， 我们又需要去添加一个额外的脚本去对所有这些条目进行排序。

最终，更新一个 npm 依赖，也就更新了许多无关的所谓 [语义更新](http://semver.org/)。这使得每一个改变都比预期想象得要大。并且不得不做一些像是提交 node_modules 或者更新到 CDN 这种对工程师来说流程比预想的要少的工作。

(这一节翻译得不好 T_T)

## 造个轮子










